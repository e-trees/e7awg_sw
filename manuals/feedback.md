# フィードバックシステムユーザマニュアル

## 1. アーキテクチャ概要
フィードバックシステムは，キャプチャした波形データをもとに AWG とキャプチャユニットの設定を変更して，
波形データの送信とキャプチャを行うための FPGA デザインです．
本デザインは，シーケンサブロックと e7awg_hw の 2 つの部分からなっており，シーケンサブロックが，
後述する**フィードバック制御コマンド**に従って e7awg_hw の各種モジュールを制御する仕組みとなっています．
e7awg_hw に関する説明は，[e7awg_hw ユーザマニュアル](./README.md) を参照してください．

以下にフィードバックシステムの概略図を示します．

![FPGA ブロック図](./feedback_figures/fpga_block_diagram.png)


### 1.1 シーケンサブロックの各モジュールとその機能
|  モジュール  |  機能  |
| ---- | ---- |
| sequencer | フィードバック制御コマンドを逐次実行しながら，コマンドの内容に応じて他のモジュールに命令を出します． |
| feedback value calculator | sequencer の命令を受けて，キャプチャデータからフィードバック値を計算します．<br> フィードバック値は，特定のフィードバック制御コマンドを処理する際に，AWG とキャプチャユニットに設定するパラメータを選択するのに使用される値です． |
| parameter loader | sequencer の命令を受けて，[波形パラメータ](./terms.md)もしくは，[キャプチャパラメータ](./terms.md)を読み出し，前者を AWG，後者をキャプチャユニットに設定します．また，キャプチャユニットに対し，キャプチャアドレスオフセットも設定します． |

### 1.2 シーケンサの状態遷移

シーケンサには 3 つの状態があり，このうち RUNNING においてのみフィードバック制御コマンドが実行されます．

![シーケンサ状態遷移](./feedback_figures/sequencer_state.png)

| 状態 | 説明 |
| ---- | ---- |
| RESET | シーケンサブロック全体をリセットしている状態です．リセット解除後にリセットが完了すると `IDLE` 状態に遷移します．<br> リセットの開始と解除は FPGA のコンフィギュレーション完了直後に自動で行われますが，シーケンサ制御レジスタでも制御可能です．シーケンサ制御レジスタの詳細は，**5.1 シーケンサ制御レジスタ一覧** を参照してください． |
| IDLE | フィードバック制御コマンドの実行開始を待っている状態です．コマンドの実行はシーケンサの start 信号の立ち上がりで開始されるほか，シーケンサ制御レジスタからも開始可能です．|
| RUNNING | フィードバック制御コマンドを実行可能な状態です．この状態でシーケンサのコマンド FIFO にコマンドが存在すると，順番にコマンドの処理を進めます．**停止フラグ**が立っているコマンドを処理すると，シーケンサはコマンドの処理を止め `IDLE` 状態に遷移します．|

各状態におけるステータス信号の値は以下の表のとおりです．
各ステータス信号の値は，シーケンサ制御レジスタの信号名と同名のビットフィールドから読み取れます．

|  状態\信号名 | wakeup | busy | done |
| ---- | ---- | ---- | ---- |
| RESET   | 0 | 0 | 0  |
| IDLE    | 1 | 0 | 0 / 1|
| RUNNING | 1 | 1 | 0  |

※`IDLE` 時の done 信号は `RUNNING` から `IDLE` に遷移した後で 1 になります．


### 1.3 フィードバック値の計算

フィードバック値は，特定のフィードバック制御コマンドを処理する際に AWG とキャプチャユニットに設定するパラメータを選択するのに使用される値で，feedback value calculator によってキャプチャデータから計算されます．
計算結果は，算出元のキャプチャデータを保存したキャプチャユニットごとに，異なるデータバス (**フィードバックチャネル**) に送られ，シーケンサから参照できるようになります．
具体的には，キャプチャユニット N  (=0~7) が保存したキャプチャデータから算出されたフィードバック値は，フィードバックチャネル N に送られます．
フィードバック制御コマンドでフィードバック値を参照する際は，このフィードバックチャネルを指定します．

現在実装されているフィードバック値算出アルゴリズムは，指定されたアドレスの四値化結果をそのままフィードバック値とするものです．

![フィードバックチャネル](./feedback_figures/feedback_channel.png)


## 2. 波形 / キャプチャパラメータフォーマット

parameter loader モジュールによってセットされる波形パラメータおよびキャプチャパラメータは，次節で示すフォーマットに従って HBM に格納されなければなりません．
HBM へのデータの格納方法は，[e7awg_hw ユーザマニュアル](./README.md) の **2.1 HBM アクセスパケットフォーマット** を参照してください．

### 2.1 波形パラメータフォーマット
波形パラメータは AWG ごとに格納領域が分かれています．
この格納領域は，**波形パラメータブロック**と呼ばれる 512 個の領域に分割され，各波形パラメータブロックには HBM 上の位置に応じて ID (0 ~ 511) が割り振られています．
波形パラメータブロックには，波形シーケンス 1 つ分の波形パラメータが含まれます．
波形シーケンスと波形パラメータの詳細は，[e7awg_hw ユーザマニュアル](./README.md) の **3.2 出力波形の定義** および **3.3 AWG 制御レジスタ一覧** を参照してください．

波形パラメータを HBM に格納する際のフォーマットは以下の図の通りです．
`波形パートアドレス N`，`波形パートワード数 N`，`ポストブランク数 N`，`チャンクリピート回数 N`は，波形シーケンスを構成する N 番目の波形チャンクのパラメータとなります．
N 番目の波形チャンクのサンプルデータは，HBM の`波形パートアドレス N`で指定したアドレスに格納してください．
サンプルデータを HBM に格納する際のフォーマットは，[e7awg_hw ユーザマニュアル](./README.md) の **3.5 HBM に格納された波形データの並び** を参照してください．

![波形パラメータフォーマット](./feedback_figures/wave_param_format.png)

### 2.2 キャプチャパラメータフォーマット
キャプチャパラメータの格納領域は**キャプチャパラメータブロック**と呼ばれ，HBM 上の位置に応じて ID (0~511) が割り振られています．
同じキャプチャパラメータブロックのパラメータは複数のキャプチャユニットに設定可能です．
ただし，キャプチャユニット 8 ~ 9 に対して以下のフィールド以外のパラメータを設定しても無効になります．

- キャプチャディレイ
- 積算区間数
- 総和区間数
- 総和区間長 0 ~ 4095
- ポストブランク 0 ~ 4095

HBM に格納する際のフォーマットは以下の図の通りです．
キャプチャパラメータの各フィールドの説明は，[e7awg_hw ユーザマニュアル](./README.md) の **4.4 キャプチャ制御レジスタ一覧** を参照してください．

![キャプチャパラメータフォーマット](./feedback_figures/capture_param_format.png)

## 3. フィードバック制御コマンド

### 3.1 コマンドの状態
フィードバック制御コマンドは，UDP/IP パケットとしてシーケンサに送られた後，以下の状態を遷移します．
コマンドが失敗状態になると，そのコマンドに対応した**コマンドエラーレポート**が発行されます．
コマンドは処理中にエラーが発生すると失敗します．
処理中のコマンドは，シーケンサ制御レジスタから中止することが可能ですが，その場合もエラーが発生したとみなされます．
コマンドエラーレポートの詳細は，**4. コマンドエラーレポート**を参照してください．

![コマンド状態遷移](./feedback_figures/cmd_state.png)

| 状態 | 説明 |
| ---- | ---- |
| 未処理 | シーケンサに到着後，シーケンサ内の FIFO に格納されている状態． |
| 処理中 | FIFO から取り出されて，処理されている状態．この状態のコマンドはシーケンサ内で最大 1 つです．|
| 成功 | 処理中にエラーが発生せずに終了した状態 |
| 失敗 | 処理中にエラーが発生して終了した状態 |


### 3.2 フィードバック制御コマンドフォーマット

フィードバック制御コマンドには，以下の 7 種類があります．
- (a) AWG スタートコマンド
- (b) キャプチャ終了フェンスコマンド
- (c) 波形パラメータ設定コマンド
- (d) キャプチャパラメータ設定コマンド
- (e) キャプチャアドレスオフセット設定コマンド
- (f) フィードバック値計算コマンド
- (g) 波形出力終了フェンスコマンド

これらのコマンドをシーケンサに追加する際は，本節で示すフォーマットに従って，**シーケンサ制御パケット**に格納して UDP データとして送信しなければなりません．
シーケンサ制御パケットの詳細は，**5.2 シーケンサ制御パケット** を参照してください．

<br>

各フォーマットの図におけるコマンドのバイトオーダとフィールドのビットナンバリングは以下の通りです．

![コマンドビットバイト定義](./feedback_figures/cmd_format_def.png)

<br>

#### 共通フィールド
全てのコマンドは，**停止フラグ**，**コマンド ID**，**コマンド No** のフィールドを持ち，これらをまとめて共通フィールドと呼びます．

![コマンド共通フィールド](./feedback_figures/cmd_common_fields.png)

| フィールド名 | 説明 |
| ---- | ---- |
| 停止フラグ | このビットが 1 になっているコマンドの処理が終わると，シーケンサはコマンドの処理を停止し，`IDLE`状態に遷移します． |
| コマンド ID | コマンドの種類を表す ID． |
| コマンド No | 個々のコマンドを識別するための番号. <br>コマンドエラーレポートで，どのコマンドがエラーを起こしたか判別するために使用します. |

<br>

#### (a) AWG スタートコマンド

任意の AWG を指定した時刻に同時にスタートします．
指定の時刻にスタートできなかった AWG があった場合，コマンドエラーレポートが発行されます．
このコマンドを中止した場合，このコマンドにより動作させた (波形出力準備中も含む) AWG を強制停止させ，
AWG の停止を確認してからコマンドが終了します．

![AWGスタートコマンド](./feedback_figures/awg_start_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x01 |
| AWG ID リスト | N bit 目が 1 のとき，N 番目の AWG をスタートします．(複数選択可能) |
| スタート時刻 | シーケンサの状態が `RUNNING` になった瞬間を 0 とし，`8 * スタート時刻` [ns] 後に AWG をスタートします．<br> **全ビットが 1 のとき，AWG の即時スタートを意味します．** このとき，AWG はコマンドの実行と同時に波形出力準備を行い，1.92 [us] （= 240 サイクル @ 125MHz）後にスタートします．|
| 終了待ちフラグ | 1 にすると，スタートした全ての AWG の波形出力が終了するまでコマンドを終了しません． |

<br>

#### (b) キャプチャ終了フェンスコマンド

任意のキャプチャユニットのキャプチャが，指定した時刻に終了しているか確認します．
終了していなかった場合，コマンドエラーレポートが発行されます．

![キャプチャ終了フェンスコマンド](./feedback_figures/capture_end_fence_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x02 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットのキャプチャ終了を確認します． (複数選択可能)|
| 終了確認時刻 | シーケンサの状態が `RUNNING` になった瞬間を 0 とし，`8 * 終了確認時刻` [ns] 後にキャプチャの終了を確認します．この時刻にキャプチャが終了していなかった場合，コマンドエラーレポートが発行されます． |
| 強制停止フラグ | 1 にすると，指定したキャプチャユニットのキャプチャが `終了確認時刻` に終了していなかった場合，それらに強制停止命令を送ります．強制停止命令は，キャプチャの終了待ちを行わない場合でも送信されます． |
| 終了待ちフラグ | 1 にすると，キャプチャ終了の確認後，指定した全てのキャプチャユニットのキャプチャが終了するまでコマンドを終了しません． |

<br>

#### (c) 波形パラメータ設定コマンド
以下の手順で，任意の AWG にフィードバック値に応じた波形パラメータを設定します
1. コマンドで指定したフィードバック値を参照して，波形パラメータの ID を選択します
2. 当該 ID のパラメータを各 AWG に割り当てられた波形パラメータ格納領域から読み出し，それぞれの AWG に設定します．

※波形パラメータ格納領域は，各 AWG が個別に持つため，格納領域ごとに当該 ID の波形パラメータをコマンドの実行前に設定しておく必要があります．

![AWGパラメータ設定コマンド](./feedback_figures/wave_param_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x03 |
| AWG ID リスト | N bit 目が 1 のとき，N 番目の AWG に波形パラメータを設定します．(複数選択可能) |
| フィードバックチャネル ID | 参照するフィードバックチャネルの ID (= 0~7) . |
| 最大チャンク番号 | 波形パラメータの中の 0 ~ `最大チャンク番号` の波形チャンクの情報を AWG に設定します． |
| ブロック ID (0~3) | AWG に設定する波形パラメータブロックの ID． <br> フィードバック値によって参照されるフィールドが変わり，フィードバック値が N (= 0~3) のとき，ブロック ID (N) が参照されます．|

<br>

#### (d) キャプチャパラメータ設定コマンド

以下の手順で，任意のキャプチャユニットにフィードバック値に応じたキャプチャパラメータを設定します．
1. コマンドで指定したフィードバック値を参照して，キャプチャパラメータの ID を選択します
2. 当該 ID のパラメータをキャプチャパラメータ格納領域から読み出し，コマンドで指定した全てのキャプチャユニットに設定します

![キャプチャパラメータ設定コマンド](./feedback_figures/capture_param_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x04 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットにキャプチャパラメータを設定します．(複数選択可能) |
| フィードバックチャネル ID | 参照するフィードバックチャネルの ID (= 0~7). |
| 設定要素 | 各ビットとキャプチャパラメータの要素が対応しており，1 にしたビットの要素がキャプチャユニットに設定されます．<br><br> bit 0 : 信号処理モジュールの有効 / 無効 <br> bit 1 : キャプチャディレイ <br> bit 2 : 積算区間数 <br> bit 3 : 総和区間数 <br> bit 4 : 総和開始点 / 終了点 <br> bit 5 : 総和区間長 0\~4095 <br> bit 6 : ポストブランク長 0\~4095 <br> bit 7 : 複素 FIR 実数 / 虚数係数 0\~15 <br> bit 8 : I データ / Q データ FIR 係数 0\~7 <br> bit 9 : 窓関数実数 / 虚数係数 0\~2047 <br> bit 10 : 四値化パラメータ a0\~c1
| ブロック ID (0~3) | キャプチャユニットに設定するキャプチャパラメータブロックの ID. <br> フィードバック値によって参照されるフィールドが変わり，フィードバック値が N (= 0~3) のとき，ブロック ID (N) が参照されます．|

<br>

#### (e) キャプチャアドレス設定コマンド

任意のキャプチャユニットに，次のキャプチャデータの格納先アドレスを設定します．

![キャプチャアドレス設定コマンド](./feedback_figures/capture_addr_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x05 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットにキャプチャアドレスを設定します．(複数選択可能) |
| アドレスオフセット | 本コマンドで指定した各キャプチャユニットに対して，`そのキャプチャユニットのデータ格納領域の先頭アドレス + アドレスオフセット` を次のキャプチャデータの保存先アドレスとして設定します．512 の倍数を指定してください．<br> キャプチャユニットとデータ格納領域の対応は，[e7awg_hw ユーザマニュアル](./README.md) の **2.2 HBM データレイアウト** を参照してください．|

<br>

#### (f) フィードバック値計算コマンド

任意のキャプチャユニットのキャプチャデータからフィードバック値を計算して，そのキャプチャユニットに対応したフィードバックチャネルに送ります．

![フィードバック値計算コマンド](./feedback_figures/feedback_val_calc_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x06 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットが保存したキャプチャデータからフィードバック値を計算し，フィードバックチャネル N に送ります．(複数選択可能) |
| アドレスオフセット | データオフセットと合わせてフィードバック値とする四値化データを指定します．フィードバック値とする四値化データが，それを保存したキャプチャユニットのデータ格納領域の先頭アドレスから数えて `A バイト目 + B ビット目` にある時`floor(A / 32)` を指定してください (A ≧ 0, B ≧ 0)．<br> ※ floor(x) = x の小数点以下切り捨て
| データオフセット | アドレスオフセットと合わせてフィードバック値とする四値化データを指定します．フィードバック値とする四値化データが，それを保存したキャプチャユニットのデータ格納領域の先頭アドレスから数えて `A バイト目 + B ビット目` にある時 `(A mod 32) * 4 + (B / 2)` を指定してください (A ≧ 0, B ≧ 0)．

#### (g) 波形出力終了フェンスコマンド

任意の AWG の波形出力が，指定した時刻に終了しているか確認します．
終了していなかった場合，コマンドエラーレポートが発行されます．

![波形出力終了フェンスコマンド](./feedback_figures/wave_gen_end_fence_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x07 |
| AWG ID リスト | N bit 目が 1 のとき，N 番目の AWG の波形出力が終了しているか確認します． (複数選択可能)|
| 終了確認時刻 | シーケンサの状態が `RUNNING` になった瞬間を 0 とし，`8 * 終了確認時刻` [ns] 後に波形出力の終了を確認します．この時刻に波形の出力が終了していなかった場合，コマンドエラーレポートが発行されます． |
| 強制停止フラグ | 1 にすると，指定した AWG の波形出力が `終了確認時刻` に終了していなかった場合，それらに強制停止命令を送ります．強制停止命令は，波形出力の終了待ちを行わない場合でも送信されます． |
| 終了待ちフラグ | 1 にすると，波形出力終了の確認後，指定した全ての AWG の波形出力が終了するまでコマンドを終了しません． |


### 3.3 フィードバック制御コマンド実行時間

3.2 で示した各フィードバック制御コマンドの実行時間を示します．
コマンドの実行時間はいくつかの部分に分けられ，それぞれ 🟢 **固定**，🔵 **可変**，🟡 **不定** のいずれかに分類されます．
各区分が示す意味は以下の表の通りです．

| 区分 | 説明 |
| ---- | ---- |
|🟢 **固定** | その部分の時間が常に一定であることを示します．|
|🔵 **可変** | その部分の時間がコマンドの実行タイミングにより変わることを示します．<br> 可変部の実行時間は，それがとり得る**最大値**を記してあります．|
|🟡 **不定** | その部分の時間が AWG やキャプチャモジュールのパラメータ等に依存しており，<br>フィードバック制御コマンド単体からは決まらないことを示します．|

本節の実行時間の横に書かれた丸マークは，その時間が丸の色と同じ上記の区分に属することを示します．

#### (a) AWG スタートコマンド

AWG スタートコマンドは `終了待ち` フラグを有効にするかどうかで実行時間が変わります．
下図の AWG スタート時刻はコマンドの `スタート時刻` フィールドで指定した値です．

**終了待ちが無効の場合**

![AWG スタートコマンドタイムチャート0](./feedback_figures/cmd_time/awg_start_0.png)

![AWG スタートコマンド式0](./feedback_figures/cmd_time/awg_start_exp_0.png)

**終了待ちが有効の場合**

![AWG スタートコマンドタイムチャート1](./feedback_figures/cmd_time/awg_start_1.png)

![AWG スタートコマンド式1](./feedback_figures/cmd_time/awg_start_exp_1.png)

<br>

<!--
$$
\begin{align*}
A &= \left\{
\begin{array}{ll}
  0 & (スタート時刻フィールドのビットが全て 1 の場合)\\
  不定 & (その他)\\
\end{array} \\
\right. \\[3ex]

& ※ A が不定なのはコマンドの実行開始時刻 (= 前のコマンドの終了時刻) に依存するため.

\\[3ex]
B &= コマンドで指定した AWG が出力するユーザ定義波形の中で最長のものに含まれるサンプル数

\end{align*}
$$
-->

#### (b) キャプチャ終了フェンスコマンド

キャプチャ終了フェンスコマンドは，`終了確認時刻` にコマンドで指定した全てのキャプチャユニットが動作を終えていたかどうかと，`終了待ち` および `強制停止` フラグを有効にするかどうかで実行時間のパターンが以下の表のように変わります．

| 終了確認時刻に<br>キャプチャが終了していた | 終了待ちフラグ | 強制停止フラグ | パターン |
| ---- | ---- | ---- | ---- |
| Yes  | don't care    | don't care    | A    |
| No   | 0             | 0             | A    |
| No   | 0             | 1             | B    |
| No   | 1             | 0             | C    |
| No   | 1             | 1             | D    |

下図の終了確認時刻はコマンドの `終了確認時刻` フィールドで指定した値です．

**パターン A**

![キャプチャ終了フェンスコマンドタイムチャートA](./feedback_figures/cmd_time/cap_end_fence_a.png)

**パターン B**

![キャプチャ終了フェンスコマンドタイムチャートB](./feedback_figures/cmd_time/cap_end_fence_b.png)

**パターン C**

![キャプチャ終了フェンスコマンドタイムチャートC](./feedback_figures/cmd_time/cap_end_fence_c.png)

**パターン D**

![キャプチャ終了フェンスコマンドタイムチャートD](./feedback_figures/cmd_time/cap_end_fence_d.png)

<br>
※1 コマンド開始時刻（= 前のコマンドの終了時刻）に依存するため <br>
※2 キャプチャパラメータに依存するため

<br>

#### (c) 波形パラメータ設定コマンド

![波形パラメータ設定コマンドタイムチャート](./feedback_figures/cmd_time/wave_param_set.png)

<br>

#### (d) キャプチャパラメータ設定コマンド

キャプチャパラメータ設定コマンドは，`設定要素` フィールドに指定したキャプチャパラメータによって実行時間が変わります．
実行時間を算出するにあたって，キャプチャパラメータを以下の表に記すグループに分けます．

| グループ | パラメータ |
| ---- | ---- |
| 1 | 信号処理モジュール有効/無効 <br> キャプチャディレイ <br> 積算区間数 <br> 総和区間数 <br> 総和開始/終了点 |
| 2 | 総和区間長 |
| 3 | ポストブランク長 |
| 4 | 複素 FIR 係数 |
| 5 | 実数 FIR 係数 |
| 6 | 窓関数係数 |
| 7 | 四値化パラメータ |

![キャプチャパラメータ設定コマンド](./feedback_figures/cmd_time/cap_param_set.png)

A = 設定するキャプチャパラメータが属するグループの番号のうち最も小さいもの


1 つのグループに属するパラメータを設定する際，実行時間 B は以下の表に従います．
グループ 1 に属するパラメータは，設定する個数によらずコマンドの実行時間は一定です．
異なるグループのパラメータを設定する場合，個々のグループに対応する実行時間の合計を超えないことが保証されます．

| グループ | B |
| ---- | ---- |
| 1 | 632 |
| 2 | 5032 |
| 3 | 5032 |
| 4 | 640 |
| 5 | 632 |
| 6 | 5032 |
| 7 | 632 |

<br>

#### (e) キャプチャアドレス設定コマンド

![キャプチャアドレス設定コマンド](./feedback_figures/cmd_time/cap_addr_set.png)

<br>

#### (f) フィードバック値計算コマンド

![フィードバック値計算コマンド](./feedback_figures/cmd_time/feedback_val_calc.png)

A = コマンドの `キャプチャユニット ID リスト` フィールドで指定したフィードバックチャネルの個数 <br>
B = コマンドの `キャプチャユニット ID リスト` フィールドで指定したフィードバックチャネルの ID (= 0 ~ 7) のうち, 最も大きい値 <br>


<br>

#### (g) 波形出力終了フェンスコマンド


波形出力終了フェンスコマンドは，`終了確認時刻` にコマンドで指定した全ての AWG の波形出力が完了していたかどうかと，`終了待ち` および `強制停止` フラグを有効にするかどうかで実行時間のパターンが以下の表のように変わります．

| 終了確認時刻に<br>波形出力が終了していた | 終了待ちフラグ | 強制停止フラグ | パターン |
| ---- | ---- | ---- | ---- |
| Yes  | don't care    | don't care    | A    |
| No   | 0             | 0             | A    |
| No   | 0             | 1             | B    |
| No   | 1             | 0             | C    |
| No   | 1             | 1             | D    |

下図の終了確認時刻はコマンドの `終了確認時刻` フィールドで指定した値です．

**パターン A**

![波形出力終了フェンスコマンドタイムチャートA](./feedback_figures/cmd_time/awg_end_fence_a.png)

**パターン B**

![波形出力終了フェンスコマンドタイムチャートB](./feedback_figures/cmd_time/awg_end_fence_b.png)

**パターン C**

![波形出力終了フェンスコマンドタイムチャートC](./feedback_figures/cmd_time/awg_end_fence_c.png)

**パターン D**

![波形出力終了フェンスコマンドタイムチャートD](./feedback_figures/cmd_time/awg_end_fence_d.png)

<br>
※1 コマンド開始時刻（= 前のコマンドの終了時刻）に依存するため <br>
※2 波形パラメータに依存するため

<br>

#### (h) 波形パラメータ選択コマンド

![波形パラメータ選択コマンドタイムチャートD](./feedback_figures/cmd_time/wave_param_selection.png)


## 4. コマンドエラーレポート

フィードバック制御コマンドの処理が失敗すると，そのコマンドのエラーの詳細情報 (**コマンドエラーレポート**) が発行されます．
発行されたコマンドエラーレポートは，シーケンサの中の専用の FIFO に格納され，これの送信が有効になっている場合，本章で示すフォーマットに従って，**シーケンサ制御パケット**に格納されて UDP データとしてシーケンサから送信されます．
コマンドエラーレポートの送信の有効/無効および，宛先 IP アドレスと UDP ポートは，シーケンサ制御レジスタから指定することができます．

### 4.1 コマンドエラーレポートフォーマット

コマンドエラーレポートには，以下の 6 種類があります．
- (a) AWG スタートコマンドエラーレポート
- (b) キャプチャ終了フェンスコマンドエラーレポート
- (c) 波形パラメータ設定コマンドエラーレポート
- (d) キャプチャパラメータ設定コマンドエラーレポート
- (e) キャプチャアドレスオフセット設定コマンドエラーレポート
- (f) フィードバック値計算コマンドエラーレポート
- (g) 波形出力終了フェンスコマンドエラーレポート

<br>

各フォーマットの図におけるコマンドエラーレポートのバイトオーダとフィールドのビットナンバリングは以下の通りです．

![コマンドエラーレポートビットバイト定義](./feedback_figures/cmd_err_format_def.png)

#### 共通フィールド
全てのコマンドエラーレポートは，**中止フラグ**，**レポート ID**，**レポート No** のフィールドを持ち，これらをまとめて共通フィールドと呼びます．

![エラーレポート共通フィールド](./feedback_figures/cmd_err_common_fields.png)

| フィールド名 | 説明 |
| ---- | ---- |
| 中止フラグ | 1 のとき，コマンドが処理中に中止されたことを表します．|
| レポート ID | レポートの種類を表す ID で，エラーを起こしたコマンドのコマンド ID と一致します． |
| レポート No | エラーを起こしたコマンドのコマンド No と一致します． |

<br>

#### (a) AWG スタートコマンドエラーレポート

AWG スタートコマンドがエラーを起こしたときに発行されます．

![AWGスタートコマンドエラー](./feedback_figures/awg_start_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x01 |
| AWG ID リスト | AWG スタートコマンドで指定した AWG のうち，指定した時刻にスタートできなかったもののリストです．<br> N bit 目が N 番目の AWG に対応しています．<br> 同コマンドがスタート時刻より前に中止された場合，このフィールドは 0 となります． |

<br>

#### (b) キャプチャ終了フェンスコマンドエラーレポート

キャプチャ終了フェンスコマンドがエラーを起こしたときに発行されます．

![キャプチャ終了フェンスコマンドエラー](./feedback_figures/capture_end_fence_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x02 |
| キャプチャユニット ID リスト | キャプチャ終了フェンスコマンドで指定したキャプチャユニットのうち，指定した時刻にキャプチャが完了していなかったもののリストです．<br> N bit 目が N 番目のキャプチャユニットに対応しています．<br> 同コマンドの強制終了フラグと終了待ちフラグは，このフィールドの結果に影響を与えません． <br> 同コマンドが `終了確認時刻` より前に中断された場合，このフィールドは 0 となります． |

<br>

#### (c) 波形パラメータ設定コマンドエラーレポート

波形パラメータ設定コマンドがエラーを起こしたときに発行されます．

![波形パラメータ設定コマンドエラー](./feedback_figures/wave_param_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x03 |
| リードエラー | 波形パラメータを HBM から読みだすときにエラーが発生すると 1 になります． |
| ライトエラー | 波形パラメータを AWG に書き込むときにエラーが発生すると 1 になります． |

<br>

#### (d) キャプチャパラメータ設定コマンドエラーレポート

キャプチャパラメータ設定コマンドがエラーを起こしたときに発行されます．

![キャプチャパラメータ設定コマンドエラー](./feedback_figures/capture_param_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x04 |
| リードエラー | キャプチャパラメータを HBM から読みだすときにエラーが発生すると 1 になります． |
| ライトエラー | キャプチャパラメータをキャプチャユニットに書き込むときにエラーが発生すると 1 になります． |

<br>

#### (e) キャプチャアドレス設定コマンドエラーレポート

キャプチャアドレス設定コマンドがエラーを起こしたときに発行されます．

![キャプチャアドレス設定コマンドエラー](./feedback_figures/capture_addr_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x05 |
| ライトエラー | キャプチャアドレスをキャプチャユニットに設定するときにエラーが発生すると 1 になります． |

<br>

#### (f) フィードバック値計算コマンドエラーレポート

フィードバック値計算コマンドがエラーを起こしたときに発行されます．

![フィードバック値計算コマンドエラー](./feedback_figures/feedback_val_calc_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x06 |
| リードエラー | キャプチャデータを HBM から読みだすときにエラーが発生すると 1 になります． |

<br>

#### (g) 波形出力終了フェンスコマンドエラーレポート

波形出力終了フェンスコマンドがエラーを起こしたときに発行されます．

![波形出力終了フェンスコマンドエラー](./feedback_figures/wave_gen_end_fence_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x07 |
| AWG ID リスト | 波形出力終了フェンスコマンドで指定した AWG のうち，指定した時刻に波形出力が完了していなかったもののリストです．<br> N bit 目が N 番目の AWG に対応しています．<br> 同コマンドの強制終了フラグと終了待ちフラグは，このフィールドの結果に影響を与えません． <br> 同コマンドが `終了確認時刻` より前に中断された場合，このフィールドは 0 となります． |

<br>

##  5. シーケンサソフトウェアインタフェース仕様

### 5.1 シーケンサ制御レジスタ一覧

シーケンサを制御するためのレジスタ一覧を以下に示します．

![シーケンサ制御レジスタ](./feedback_figures/sequencer_ctrl_regs.png)

### 5.2 シーケンサ制御パケットフォーマット

シーケンサとサーバ間でやりとりされる UDP データをシーケンサ制御パケットと呼びます．
シーケンサ制御パケットには，以下の 7 種類があります．
(a)，(c)，(e) がシーケンサに送るパケットで，(b)，(d)，(f) がその応答としてシーケンサから送られるパケットです．
(g) はコマンドエラーレポートの送信を有効にしていた場合，シーケンサが送信するパケットです．

- (a) シーケンサ制御レジスタ読み出しパケット
- (b) シーケンサ制御レジスタ読み出し応答パケット
- (c) シーケンサ制御レジスタ書き込みパケット
- (d) シーケンサ制御レジスタ書き込み応答パケット
- (e) フィードバック制御コマンド追加パケット
- (f) フィードバック制御コマンド追加応答パケット
- (g) コマンドエラーレポートパケット

#### (a) シーケンサ制御レジスタ読み出しパケット
このパケットをシーケンサに送信すると，アドレス `A` から `A + 3` までのレジスタ値が，シーケンサ制御レジスタ読み出し応答パケットとして返ってきます．A は 4 の倍数を指定してください．バイト数は 4 で固定です．

![シーケンサ制御レジスタ読み出しパケット](./feedback_figures/udp_seq_reg_read.png)


#### (b) シーケンサ制御レジスタ読み出し応答パケット
レジスタ値が正常に読みだせた場合，**アドレス** と **バイト数** フィールドには，シーケンサ制御レジスタ読み出しパケットで指定した値が入っています．**レジスタ値 1** には，アドレス `A` から `A + 3` までのレジスタ値が格納されています．

![シーケンサ制御レジスタ読み出し応答パケット](./feedback_figures/udp_seq_reg_read_resp.png)


#### (c) シーケンサ制御レジスタ書き込みパケット
このパケットをシーケンサに送信すると，アドレス `A` から `A + 3` までのレジスタに，**レジスタ値 1** の値を書き込みます．A は 4 の倍数を指定してください．バイト数は 4 で固定です．

![シーケンサ制御レジスタ書き込みパケット](./feedback_figures/udp_seq_reg_write.png)


#### (d) シーケンサ制御レジスタ書き込み応答パケット
レジスタ値が正常に書き込めた場合，**アドレス** と **バイト数** フィールドには，シーケンサ制御レジスタ書き込みパケットで指定した値が入っています．

![シーケンサ制御レジスタ書き込み応答パケット](./feedback_figures/udp_seq_reg_write_resp.png)


#### (e) フィードバック制御コマンド追加パケット
このパケットをシーケンサに送信すると，フィードバック制御コマンド 1 ~ N が，シーケンサの FIFO にこの順番で追加されます．
**バイト数**フィールドには，`パケット内の全コマンドのバイト数 + 8` を指定してください．
**コマンド数**フィールドには，このパケットのコマンドの個数 (= N) を指定してください．
パケット内の全コマンドのバイト数が，現在のコマンド FIFO の空き領域を超えないようにしてください．
現在のコマンド FIFO の空き領域は，シーケンサ制御レジスタの**コマンド FIFO 空き領域レジスタ**から取得できます．

![フィードバック制御コマンド追加パケット](./feedback_figures/udp_cmd_add.png)


#### (f) フィードバック制御コマンド追加応答パケット

コマンドが正常に追加できた場合，**バイト数**フィールドには，フィードバック制御コマンド追加パケットで指定した値が入っています．

![フィードバック制御コマンド追加応答パケット](./feedback_figures/udp_cmd_add_resp.png)


#### (g) コマンドエラーレポートパケット
本パケットはコマンドエラーレポートの送信を有効にしていた場合，シーケンサが送信するパケットです．
**バイト数**フィールドには，`コマンドエラーレポート 1 ~ N までのバイト数 + 8` が格納されています．

![コマンドエラーレポートパケット](./feedback_figures/udp_cmd_err_report.png)


