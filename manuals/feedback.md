# フィードバックシステムユーザマニュアル

## 1. アーキテクチャ概要
フィードバックシステムは，キャプチャした波形データをもとに AWG とキャプチャユニットの設定を変更して，
波形データの送信とキャプチャを行うための FPGA デザインです．
本デザインは，シーケンサブロックと e7awg_hw の 2 つの部分からなっており，シーケンサブロックが，
後述する**フィードバック制御コマンド**に従って e7awg_hw の各種モジュールを制御する仕組みとなっています．
e7awg_hw に関する説明は，[e7awg_hw ユーザマニュアル](./README.md) を参照してください．

以下にフィードバックシステムの概略図を示します．

![FPGA ブロック図](./feedback_figures/fpga_block_diagram.png)


### 1.1 シーケンサブロックの各モジュールとその機能
|  モジュール  |  機能  |
| ---- | ---- |
| sequencer | フィードバック制御コマンドを逐次実行しながら，コマンドの内容に応じて他のモジュールに命令を出します． |
| feedback value calculator | sequencer の命令を受けて，キャプチャデータからフィードバック値を計算します．<br> フィードバック値は，AWG とキャプチャユニットに設定すべきパラメータを選択するのに使用されます． |
| parameter loader | sequencer の命令を受けて，波形パラメータもしくは，キャプチャパラメータを読み出し，前者を AWG，後者をキャプチャユニットに設定します．また，キャプチャユニットに対し，キャプチャアドレスオフセットも設定します． |

### 1.2 シーケンサの状態遷移

シーケンサには 3 つの状態があり，このうち RUNNING においてのみフィードバック制御コマンドが実行されます．
状態遷移を起こす要因として以下のものがあります．

- シーケンサの start 信号の立ち上がり
- 特定のシーケンサ制御レジスタの操作
- 停止フラグの立ったコマンドの処理

シーケンサ制御レジスタについては，**XXXXXXX** を参照してください．

![シーケンサ状態遷移](./feedback_figures/sequencer_state.png)

| 状態 | 説明 |
| ---- | ---- |
| RESET | シーケンスブロック全体をリセットしている状態です．リセット解除後にリセットが完了すると `IDLE` 状態に遷移します．<br> リセットの開始と解除は FPGA のコンフィギュレーション完了直後に自動で行われますが，シーケンサ制御レジスタでも制御可能です． |
| IDLE | フィードバック制御コマンドの実行開始を待っている状態です．コマンドの実行はシーケンサの start 信号の立ち上がりで開始されるほか，シーケンサ制御レジスタからも開始可能です．|
| RUNNING | フィードバック制御コマンドを実行可能な状態です．この状態でシーケンサのコマンド FIFO にコマンドが存在すると，順番にコマンドの処理を進めます．**停止フラグ**が立っているコマンドを処理すると，シーケンサはコマンドの処理を止め `IDLE` 状態に遷移します．|

各状態におけるステータス信号の値は以下の表のとおりです．
各ステータス信号の値は，シーケンサ制御レジスタの信号名と同名のビットフィールドから読み取れます．

|  状態\信号名 | wakeup | busy | done |
| ---- | ---- | ---- | ---- |
| RESET   | 0 | 0 | 0  |
| IDLE    | 1 | 0 | 0 / 1|
| RUNNING | 1 | 1 | 0  |

※`IDLE` 時の done 信号は `RUNNING` から `IDLE` に遷移した後で 1 になります．


### 1.3 フィードバック値の計算

フィードバック値は，AWG とキャプチャユニットに設定するパラメータを選択するのに使用される値で，feedback value calculator によってキャプチャデータから算出されます．
feedback value calculator は，フィードバック値を算出元のキャプチャデータを保存したキャプチャユニットに応じて，異なる伝送路 (**フィードバックチャネル**) に送ります．
具体的には，キャプチャユニット N  (=0~7) が保存したキャプチャデータから算出されたフィードバック値をフィードバックチャネル N に送ります．
フィードバックチャネルはシーケンサにつながっており，特定のフィードバック制御コマンドの処理の際に参照されます．

現在実装されているフィードバック値算出アルゴリズムは，指定されたアドレスの四値化結果をそのままフィードバック値とするものです．

![フィードバックチャネル](./feedback_figures/feedback_channel.png)

## 2. フィードバック制御コマンド

### 2.1 コマンドの状態
フィードバック制御コマンドは，UDP/IP パケットとしてシーケンサに送られた後，以下の状態を持ちます．
コマンドが失敗状態になると，そのコマンドに対応した**コマンドエラーレポート**が発行されます．
コマンドは，処理中にエラーが発生するか，中止されるかすると失敗します．
コマンドの中止は，シーケンサ制御レジスタから行えます．

![コマンド状態遷移](./feedback_figures/cmd_state.png)

| 状態 | 説明 |
| ---- | ---- |
| 未処理 | シーケンサに到着後，シーケンサ内の FIFO に格納されている状態． |
| 処理中 | FIFO から取り出されて，処理されている状態．この状態のコマンドはシーケンサ内で最大 1 つです．|
| 成功 | 処理が終了した状態 (処理中のエラーなし and 中止されていない) |
| 失敗 | 処理が終了した状態 (処理中のエラー有り or 中止された) |

### 2.2 コマンドエラーレポート

コマンドの処理中にエラーが発生した場合，コマンドの終了時にそのコマンドに対応したエラーレポートが発行されます．
発行されたコマンドエラーレポートは，シーケンサの中の専用の FIFO に格納され，これの送信が有効になっている場合，シーケンサ制御レジスタに書かれた IP アドレスと UDP ポートに向けて送信されます．
コマンドエラーレポートの送信の有効/無効は，シーケンサ制御レジスタで切り替えることができます．


### 2.3 フィードバック制御コマンドフォーマット

フィードバック制御コマンドには，以下の 6 種類があります．
- (a) AWG スタートコマンド
- (b) キャプチャ終了フェンスコマンド
- (c) 波形パラメータ設定コマンド
- (d) キャプチャパラメータ設定コマンド
- (e) キャプチャアドレスオフセット設定コマンド
- (f) フィードバック値計算コマンド

これらのコマンドを，後述する**シーケンサ通信パケット**に格納して UDP データとして送る際のフォーマットについて記します．
なお，図中におけるコマンドのバイトオーダと各フィールドのビットナンバリングは以下の通りです．

![コマンドビットバイト定義](./feedback_figures/cmd_format_def.png)

<br>

#### 共通フィールド
全てのコマンドは，**停止フラグ**，**コマンド ID**，**コマンド No** のフィールドを持ち，これらをまとめて共通フィールドと呼びます．

![コマンド共通フィールド](./feedback_figures/cmd_common_fields.png)

| フィールド名 | 説明 |
| ---- | ---- |
| 停止フラグ | このビットが 1 になっているコマンドの処理が終わると，シーケンサはコマンドの処理を停止します． |
| コマンド ID | コマンドの種類を表す ID． |
| コマンド No | 個々のコマンドを識別するための番号. <br>コマンドエラーレポートで，どのコマンドがエラーを起こしたか判別するために使用します. |

<br>

#### (a) AWG スタートコマンド

任意の AWG を指定した時刻に同時にスタートします．
このコマンドを中止した場合，このコマンドにより動作させた (波形出力準備中も含む) AWG を強制停止させ，
AWG の停止を確認してからコマンドが終了します．

![AWGスタートコマンド](./feedback_figures/awg_start_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x01 |
| AWG ID リスト | N bit 目が 1 のとき，N 番目の AWG をスタートします．(複数選択可能) |
| スタート時刻 | シーケンサの状態が RUNNING になった瞬間を 0 とし，`8 * スタート時刻` [ns] 後に AWG をスタートします． |

<br>

#### (b) キャプチャ終了フェンスコマンド

任意のキャプチャユニットのキャプチャが，指定した時刻に終了しているか確認します．
終了していなかった場合，コマンドエラーレポートが発行されます．

![キャプチャ終了フェンスコマンド](./feedback_figures/capture_end_fence_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x02 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットのキャプチャ終了を確認します． (複数選択可能)|
| 確認時刻 | シーケンサの状態が RUNNING になった瞬間を 0 とし，`8 * 確認時刻` [ns] 後にキャプチャの終了を確認します．この時刻にキャプチャが終了していなかった場合，コマンドエラーレポートが発行されます． |
| 強制停止フラグ | 1 にすると，指定したキャプチャユニットのキャプチャが，確認時刻に終了していなかった場合，それらに強制停止命令を送ります．強制停止命令は，キャプチャの終了待ちを行わない場合でも送信されます． |
| 終了待ちフラグ | 1 にすると，キャプチャ終了の確認後，指定した全てのキャプチャユニットのキャプチャが終了するまで，コマンドを終了しません． |

<br>

#### (c) 波形パラメータ設定コマンド

任意の AWG にフィードバック値に応じた波形パラメータを設定します．

![AWGパラメータ設定コマンド](./feedback_figures/wave_param_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x03 |
| AWG ID リスト | N bit 目が 1 のとき，N 番目の AWG に波形パラメータを設定します．(複数選択可能) |
| フィードバックチャネル ID | 参照するフィードバックチャネルの ID. |
| 最大チャンク番号 | 波形パラメータの中の，この番号以下の波形チャンクの情報を AWG に設定します．波形パラメータの詳細は，**XXXX**を参照してください． |
| パラメータID N | 参照したフィードバック値が N のとき，波形レジストリ内でこの ID の場所にある波形パラメータを AWG に設定します．波形レジストリの詳細は，**XXXX**を参照してください． |

<br>

#### (d) キャプチャパラメータ設定コマンド

任意のキャプチャユニットにフィードバック値に応じたキャプチャパラメータを設定します．

![キャプチャパラメータ設定コマンド](./feedback_figures/capture_param_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x04 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットにキャプチャパラメータを設定します．(複数選択可能) |
| フィードバックチャネル ID | 参照するフィードバックチャネルの ID. |
| 設定要素 | 各ビットとキャプチャパラメータの要素が対応しており，1 にしたビットの要素がキャプチャユニットに設定されます．キャプチャパラメータの詳細は，**XXXX**を参照してください．<br><br> bit 0 : 信号処理モジュールの有効 / 無効 <br> bit 1 : キャプチャディレイ <br> bit 2 : 積算区間数 <br> bit 3 : 総和区間数 <br> bit 4 : 総和開始点 / 終了点 <br> bit 5 : 総和区間長 0~4095 <br> bit 6 : ポストブランク長 0~4095 <br> bit 7 : 複素 FIR 実数 / 虚数係数 0~15 <br> bit 8 : I データ / Q データ FIR 係数 0~7 <br> bit 9 : 窓関数実数 / 虚数係数 0~2047 <br> bit 10 : 四値化パラメータ a0~c1
| パラメータID N | 参照したフィードバック値が N のとき，キャプチャパラメータレジストリ内でこの ID の場所にあるキャプチャパラメータをキャプチャユニットに設定します．キャプチャパラメータレジストリの詳細は，**XXXX**を参照してください． |

<br>

#### (e) キャプチャアドレス設定コマンド

任意のキャプチャユニットに，次のキャプチャデータの格納先アドレスを設定します．

![キャプチャアドレス設定コマンド](./feedback_figures/capture_addr_set_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x05 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットにキャプチャアドレスを設定します．(複数選択可能) |
| アドレスオフセット | 本コマンドで指定した各キャプチャユニットに対して，`そのキャプチャユニットのデータ格納領域の先頭アドレス + アドレスオフセット` を次のキャプチャデータの保存先アドレスとして設定します．512 の倍数を指定してください． |

<br>

#### (f) フィードバック値計算コマンド

任意のキャプチャユニットのキャプチャデータからフィードバック値を計算して，フィードバックチャネルに送ります．

![フィードバック値計算コマンド](./feedback_figures/feedback_val_calc_cmd.png)

| フィールド名 | 説明 |
| ---- | ---- |
| コマンド ID | 0x06 |
| キャプチャユニット ID リスト | N bit 目が 1 のとき，N 番目のキャプチャユニットが保存したキャプチャデータからフィードバック値を計算し，フィードバックチャネル N に送ります．(複数選択可能) |
| アドレスオフセット | データオフセットと合わせてフィードバック値とする四値化データを指定します．フィードバック値とする四値化データが，それを保存したキャプチャユニットのデータ格納領域の先頭アドレスから数えて，A バイト目 + B ビット目にある時`floor(A / 32)` を指定してください (A ≧ 0, B ≧ 0)．<br> ※ floor(x) = x の小数点以下切り捨て
| データオフセット | アドレスオフセットと合わせてフィードバック値とする四値化データを指定します．フィードバック値とする四値化データが，それを保存したキャプチャユニットのデータ格納領域の先頭アドレスから数えて A バイト目 + B ビット目にある時 `(A mod 32) * 4 + (B / 2)` を指定してください (A ≧ 0, B ≧ 0)．

###  2.4 コマンドエラーレポートフォーマット

コマンドエラーレポートには，以下の 6 種類があります．
- (a) AWG スタートコマンドエラーレポート
- (b) キャプチャ終了フェンスコマンドエラーレポート
- (c) 波形パラメータ設定コマンドエラーレポート
- (d) キャプチャパラメータ設定コマンドエラーレポート
- (e) キャプチャアドレスオフセット設定コマンドエラーレポート
- (f) フィードバック値計算コマンドエラーレポート

<br>

#### 共通フィールド
全てのコマンドエラーレポートは，**中止フラグ**，**レポート ID**，**レポート No** のフィールドを持ち，これらをまとめて共通フィールドと呼びます．

![エラーレポート共通フィールド](./feedback_figures/cmd_err_common_fields.png)

| フィールド名 | 説明 |
| ---- | ---- |
| 中止フラグ | 1 のとき，コマンドが処理中に中止されたことを表します．<br> コマンドの中止は，シーケンサ制御レジスタから行えます． |
| レポート ID | レポートの種類を表す ID で，エラーを起こしたコマンドのコマンド ID と一致します． |
| レポート No | エラーを起こしたコマンドのコマンド No と一致します． |

<br>

#### (a) AWG スタートコマンドエラーレポート

AWG スタートコマンドがエラーを起こしたときに発行されます．

![AWGスタートコマンドエラー](./feedback_figures/awg_start_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x01 |
| AWG ID リスト | AWG スタートコマンドで指定した AWG のうち，指定した時刻にスタートできなかったもののリストです．<br> N bit 目が N 番目の AWG に対応しています．<br> 同コマンドが，スタート時刻より前に中止された場合，このフィールドは 0 となります． |

<br>

#### (b) キャプチャ終了フェンスコマンドエラーレポート

キャプチャ終了フェンスコマンドがエラーを起こしたときに発行されます．

![キャプチャ終了フェンスコマンドエラー](./feedback_figures/capture_end_fence_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x02 |
| キャプチャユニット ID リスト | キャプチャ終了フェンスコマンドで指定したキャプチャユニットのうち，指定した時刻にキャプチャが完了していなかったもののリストです．<br> N bit 目が N 番目のキャプチャユニットに対応しています．<br> 同コマンドの強制終了フラグと終了待ちフラグは，このフィールドの結果に影響を与えません． <br> 同コマンドが，確認時刻より前に中断された場合，このフィールドは 0 となります． |

<br>

#### (c) 波形パラメータ設定コマンドエラーレポート

波形パラメータ設定コマンドがエラーを起こしたときに発行されます．

![波形パラメータ設定コマンドエラー](./feedback_figures/wave_param_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x03 |
| リードエラー | 波形パラメータを HBM から読みだすときにエラーが発生すると 1 になります． |
| ライトエラー | 波形パラメータを AWG に書き込むときにエラーが発生すると 1 になります． |

<br>

#### (d) キャプチャパラメータ設定コマンドエラーレポート

キャプチャパラメータ設定コマンドがエラーを起こしたときに発行されます．

![キャプチャパラメータ設定コマンドエラー](./feedback_figures/capture_param_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x04 |
| リードエラー | キャプチャパラメータを HBM から読みだすときにエラーが発生すると 1 になります． |
| ライトエラー | キャプチャパラメータをキャプチャユニットに書き込むときにエラーが発生すると 1 になります． |

<br>

#### (e) キャプチャアドレス設定コマンドエラーレポート

キャプチャアドレス設定コマンドがエラーを起こしたときに発行されます．

![キャプチャアドレス設定コマンドエラー](./feedback_figures/capture_addr_set_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x05 |
| ライトエラー | キャプチャアドレスをキャプチャユニットに設定するときにエラーが発生すると 1 になります． |

<br>

#### (f) フィードバック値計算コマンドエラーレポート

フィードバック値計算コマンドがエラーを起こしたときに発行されます．

![フィードバック値計算コマンドエラー](./feedback_figures/feedback_val_calc_cmd_err.png)

| フィールド名 | 説明 |
| ---- | ---- |
| レポート ID | 0x06 |
| リードエラー | キャプチャデータを HBM から読みだすときにエラーが発生すると 1 になります． |


##  3. シーケンサソフトウェアインタフェース仕様

### 3.1 シーケンサ制御レジスタ一覧

シーケンサを制御するためのレジスタ一覧を以下に示します．

![シーケンサ制御レジスタ](./feedback_figures/sequencer_ctrl_regs.png)

### シーケンサ通信パケット

以下の 3 種類のデータは，UDP データとしてシーケンサとこれを操作するサーバ間で送受信されます．

- シーケンサ制御レジスタの値
- フィードバック制御コマンド
- コマンドエラーレポート

シーケンサとサーバ間でやりとりされる UDP データをシーケンサ通信パケットと呼びます．
シーケンサ通信パケットには，以下の 7 種類があり，(A)，(C)，(E) がシーケンサに送るパケットで，(B)，(D)，(F)，(G) がシーケンサから送られるパケットです．

- (A) シーケンサ制御レジスタ読み出しパケット
- (B) シーケンサ制御レジスタ読み出し応答パケット
- (C) シーケンサ制御レジスタ書き込みパケット
- (D) シーケンサ制御レジスタ書き込み応答パケット
- (E) フィードバック制御コマンド追加パケット
- (F) フィードバック制御コマンド追加応答パケット
- (G) コマンドエラーレポートパケット

#### (A) シーケンサ制御レジスタ読み出しパケット
このパケットをシーケンサに送信すると，アドレス `A` から `A + 3` までのレジスタ値が，シーケンサ制御レジスタ読み出し応答パケットとして返ってきます．A は 4 の倍数を指定してください．バイト数は 4 で固定です．

![シーケンサ制御レジスタ読み出しパケット](./feedback_figures/udp_seq_reg_read.png)


#### (B) シーケンサ制御レジスタ読み出し応答パケット
レジスタ値が正常に読みだせた場合，**アドレス** と **バイト数** フィールドには，シーケンサ制御レジスタ読み出しパケットで指定した値が入っています．**レジスタ値 1** には，アドレス `A` から `A + 3` までのレジスタ値が格納されています．

![シーケンサ制御レジスタ読み出し応答パケット](./feedback_figures/udp_seq_reg_read_resp.png)



## 5. レジストリ構造

